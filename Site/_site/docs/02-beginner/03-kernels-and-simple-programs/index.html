<!DOCTYPE html>
<html lang="en-US">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Kernels &amp; Simple Programs | ILGPU - A Modern GPU Compiler for .Net Programs</title>
<meta name="generator" content="Jekyll v3.9.3" />
<meta property="og:title" content="Kernels &amp; Simple Programs" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Tutorial 03 Kernels and Simple Programs." />
<meta property="og:description" content="Tutorial 03 Kernels and Simple Programs." />
<link rel="canonical" href="http://localhost:4000/docs/02-beginner/03-kernels-and-simple-programs/" />
<meta property="og:url" content="http://localhost:4000/docs/02-beginner/03-kernels-and-simple-programs/" />
<meta property="og:site_name" content="ILGPU - A Modern GPU Compiler for .Net Programs" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2023-08-18T23:46:02-04:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Kernels &amp; Simple Programs" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2023-08-18T23:46:02-04:00","datePublished":"2023-08-18T23:46:02-04:00","description":"Tutorial 03 Kernels and Simple Programs.","headline":"Kernels &amp; Simple Programs","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/docs/02-beginner/03-kernels-and-simple-programs/"},"url":"http://localhost:4000/docs/02-beginner/03-kernels-and-simple-programs/"}</script>
<!-- End Jekyll SEO tag -->
<!-- ARSHA Fonts -->
    <link href="/assets/css/fonts.css" rel="stylesheet">
    <!-- ARSHA Fonts -->

    <!-- ARSHA Vendor CSS Files -->
    <link href="/assets/vendor/aos/aos.css" rel="stylesheet">
    <link href="/assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="/assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">
    <link href="/assets/vendor/boxicons/css/boxicons.min.css" rel="stylesheet">
    <link href="/assets/vendor/glightbox/css/glightbox.min.css" rel="stylesheet">
    <link href="/assets/vendor/remixicon/remixicon.css" rel="stylesheet">
    <link href="/assets/vendor/swiper/swiper-bundle.min.css" rel="stylesheet">
    <!-- ARSHA Vendor CSS Files -->

    <!-- Normalize CSS -->
    <link rel="stylesheet" href="/assets/css/normalize.css">
    <!-- Normalize CSS -->

    <!-- ARSHA Template Main CSS File -->
    <link rel="stylesheet"
          href="/assets/css/sass.css">
    <!-- ARSHA Template Main CSS File -->

    <!-- custom CSS Files -->
    <link rel="stylesheet" href="/assets/css/custom.css">
    <!-- custom CSS Files --><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="ILGPU - A Modern GPU Compiler for .Net Programs" /><!-- Favicons -->
<link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicon/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicon/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicon/favicon-16x16.png">
<link rel="manifest" href="/assets/img/favicon/site.webmanifest">
<link rel="mask-icon" href="/assets/img/favicon/safari-pinned-tab.svg" color="#5bbad5">
<link rel="shortcut icon" href="/assets/img/favicon/favicon.ico">
<meta name="msapplication-TileColor" content="#2b5797">
<meta name="msapplication-config" content="/assets/img/favicon/browserconfig.xml">
<meta name="theme-color" content="#ffffff">
<!-- Favicons -->

<!-- Extras CSS -->
<link rel="stylesheet" href="/assets/css/site.css">
<!-- Extras CSS -->

        <!-- Code Highlighting -->
<link rel="stylesheet" href="/assets/vendor/prism/prism.css">
<!-- Code Highlighting -->

<!-- Extras CSS -->
<link rel="stylesheet" href="/assets/css/doc.css">

<!-- Extras CSS -->

    

    

</head>


<body>











<header id="header" class="fixed-top">
    <div class="container d-flex align-items-center">

        <a href="/" class="logo me-auto"></a>

        <nav id="navbar" class="navbar">
            <ul>
                <li class="dropdown">
                    <a href="#" class=""><span>About</span> <i
                                class="bi bi-chevron-down"></i></a>
                    <ul>
                        <li><a href="/#learn-more" class="scrollto">Learn More</a></li>
                        <li><a href="/#highlights" class="scrollto">Highlights</a></li>
                        <li><a href="/#features" class="scrollto">Features</a></li>
                        <li><a href="/#news" class="scrollto">News</a></li>
                        <li><a href="/#faq" class="scrollto">FAQ</a></li>
                    </ul>
                </li>

                <li class="dropdown">
                    <a href="#"
                       class=""><span>Project</span>
                        <i class="bi bi-chevron-down"></i></a>
                    <ul>
                        <li><a target="_blank" href="https://github.com/m4rs-mt/ILGPU">Sourcecode</a></li>
                        <li><a href="/releases/">Releases</a></li>
                        <li><a href="/milestones/">Milestones</a></li>
                    </ul>
                </li>

                <li><a class="nav-link active"
                       href="/docs/">Documentation</a></li>
                <li><a class="nav-link" target="_blank" href="https://discord.com/invite/X6RBCff">Discord</a></li>
                <li><a class="getstarted scrollto" href="/#cta">Get Started</a></li>
            </ul>
            <i class="bi bi-list mobile-nav-toggle"></i>
        </nav>
    </div>
</header><!-- End Header -->



<!-- ======= Sidebar Section ======= -->
<section id="sidebar">
    <div id="sidebar-header">
        
        
            <div class="container">
                <div class="row">
                    <a href="/docs/" class="col-9 my-auto"><h4 class="mb-0">Documentation</h4></a>
                    <svg xmlns="http://www.w3.org/2000/svg" id="sidebar-collapse-icon" class="icon icon-tabler icon-tabler-chevron-left text-white col-3 my-auto" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                        <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                        <path d="M15 6l-6 6l6 6"></path>
                    </svg>
                </div>
            </div>
        
    </div>

    
        <div id="search" class="ms-4 mb-4">
            <input type="search" class="typeahead form-control" placeholder="Search..." aria-label="Search" size="18" />
        </div>
    

    <nav id="wiki-nav">
        
        
            <div class="section">
                <h5>Primers</h5>
                <ul>
                    
                        
                        
                            
                            
                            <li><a href="/docs/01-primers/01-setting-up-ilgpu/"
                                   >Setting Up ILGPU</a></li>
                        
                    
                        
                        
                            
                            
                            <li><a href="/docs/01-primers/02-a-gpu-is-not-a-cpu/"
                                   >A GPU Is Not A CPU</a></li>
                        
                    
                        
                        
                            
                            
                            <li><a href="/docs/01-primers/03-memory-and-bandwidth-threads/"
                                   >Memory & Bandwidth Threads</a></li>
                        
                    
                </ul>
            </div>
        
            <div class="section">
                <h5>Beginner</h5>
                <ul>
                    
                        
                        
                            
                            
                            <li><a href="/docs/02-beginner/01-context-and-accelerators/"
                                   >Context & Accelerators</a></li>
                        
                    
                        
                        
                            
                            
                            <li><a href="/docs/02-beginner/02-memorybuffers-and-arrayviews/"
                                   >MemoryBuffers & ArrayViews</a></li>
                        
                    
                        
                        
                            
                            
                            <li><a href="/docs/02-beginner/03-kernels-and-simple-programs/"
                                   class="text-white">Kernels & Simple Programs</a></li>
                        
                    
                        
                        
                            
                            
                            <li><a href="/docs/02-beginner/04-structs/"
                                   >Structs</a></li>
                        
                    
                </ul>
            </div>
        
            <div class="section">
                <h5>Advanced</h5>
                <ul>
                    
                        
                        
                            
                            
                            <li><a href="/docs/03-advanced/01-memory-buffers-and-views/"
                                   >Memory Buffers & Views</a></li>
                        
                    
                        
                        
                            
                            
                            <li><a href="/docs/03-advanced/02-kernels/"
                                   >Kernels</a></li>
                        
                    
                        
                        
                            
                            
                            <li><a href="/docs/03-advanced/03-shared-memory/"
                                   >Shared Memory</a></li>
                        
                    
                        
                        
                            
                            
                            <li><a href="/docs/03-advanced/04-math-functions/"
                                   >Math Functions</a></li>
                        
                    
                        
                        
                            
                            
                            <li><a href="/docs/03-advanced/05-dynamically-specialized-kernels/"
                                   >Dynamically Specialized Kernels</a></li>
                        
                    
                        
                        
                            
                            
                            <li><a href="/docs/03-advanced/06-debugging-and-profiling/"
                                   >Debugging & Profiling</a></li>
                        
                    
                        
                        
                            
                            
                            <li><a href="/docs/03-advanced/07-inside-ilgpu/"
                                   >Inside ILGPU</a></li>
                        
                    
                </ul>
            </div>
        
            <div class="section">
                <h5>Upgrade Guides</h5>
                <ul>
                    
                        
                        
                            
                            
                            <li><a href="/docs/04-upgrade-guides/01-v0-8-x-to-v0-9-x/"
                                   >v0.8.X to v0.9.X</a></li>
                        
                    
                        
                        
                            
                            
                            <li><a href="/docs/04-upgrade-guides/02-v0-8-0-to-v0-8-1/"
                                   >v0.8.0 to v0.8.1</a></li>
                        
                    
                        
                        
                            
                            
                            <li><a href="/docs/04-upgrade-guides/03-v0-7-x-to-v0-8-x/"
                                   >v0.7.X to v0.8.X</a></li>
                        
                    
                        
                        
                            
                            
                            <li><a href="/docs/04-upgrade-guides/04-v0-6-x-to-v0-7-x/"
                                   >v0.6.X to v0.7.X</a></li>
                        
                    
                        
                        
                            
                            
                            <li><a href="/docs/04-upgrade-guides/05-v0-3-x-to-v0-5-x/"
                                   >v0.3.X to v0.5.X</a></li>
                        
                    
                        
                        
                            
                            
                            <li><a href="/docs/04-upgrade-guides/06-v0-1-x-to-v0-2-x/"
                                   >v0.1.X to v0.2.X</a></li>
                        
                    
                </ul>
            </div>
        
        <ul>
            
        </ul>
    </nav>

    
</section><!-- End Sidebar Section -->


<main id="main">
    


<!-- ======= Breadcrumbs ======= -->
<section id="breadcrumbs" class="breadcrumbs">
    <div class="container">
        <ol>
            <li><a href="/">Home</a></li>
            <li>Kernels & Simple Programs</li>
        </ol>
        <h2>Kernels & Simple Programs</h2>
    </div>
</section><!-- End Breadcrumbs -->


    
        <!-- ======= Inner Page Section ======= -->
        <section id="wiki-main" class="inner-page collapsed">
            <div class="container-fluid">
                <h1 id="tutorial-03-kernels-and-simple-programs">Tutorial 03 Kernels and Simple Programs.</h1>

<p>In this tutorial we actually do work on the GPU!</p>

<h2 id="lets-start-with-an-example">Lets start with an example.</h2>

<p>I think the easiest way to explain this is taking the simplest example I can think of and decomposing it.</p>

<p>This is a modified version of the sample from Primer 01.</p>

<div class="language-c# highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">using</span> <span class="nn">ILGPU</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">ILGPU.Runtime</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System</span><span class="p">;</span>

<span class="k">public</span> <span class="k">static</span> <span class="k">class</span> <span class="nc">Program</span>
<span class="p">{</span>
    <span class="k">static</span> <span class="k">void</span> <span class="nf">Kernel</span><span class="p">(</span><span class="n">Index1D</span> <span class="n">i</span><span class="p">,</span> <span class="n">ArrayView</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;</span> <span class="n">data</span><span class="p">,</span> <span class="n">ArrayView</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;</span> <span class="n">output</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">output</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">=</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span> <span class="p">%</span> <span class="n">data</span><span class="p">.</span><span class="n">Length</span><span class="p">];</span>
    <span class="p">}</span>

    <span class="k">static</span> <span class="k">void</span> <span class="nf">Main</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">// Initialize ILGPU.</span>
        <span class="n">Context</span> <span class="n">context</span> <span class="p">=</span> <span class="n">Context</span><span class="p">.</span><span class="nf">CreateDefault</span><span class="p">();</span>
        <span class="n">Accelerator</span> <span class="n">accelerator</span> <span class="p">=</span> <span class="n">context</span><span class="p">.</span><span class="nf">GetPreferredDevice</span><span class="p">(</span><span class="n">preferCPU</span><span class="p">:</span> <span class="k">false</span><span class="p">)</span>
                                  <span class="p">.</span><span class="nf">CreateAccelerator</span><span class="p">(</span><span class="n">context</span><span class="p">);</span>

        <span class="c1">// Load the data.</span>
        <span class="n">MemoryBuffer1D</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="n">Stride1D</span><span class="p">.</span><span class="n">Dense</span><span class="p">&gt;</span> <span class="n">deviceData</span> <span class="p">=</span> <span class="n">accelerator</span><span class="p">.</span><span class="nf">Allocate1D</span><span class="p">(</span><span class="k">new</span> <span class="kt">int</span><span class="p">[]</span> <span class="p">{</span> <span class="m">0</span><span class="p">,</span> <span class="m">1</span><span class="p">,</span> <span class="m">2</span><span class="p">,</span> <span class="m">3</span><span class="p">,</span> <span class="m">4</span><span class="p">,</span> <span class="m">5</span><span class="p">,</span> <span class="m">6</span><span class="p">,</span> <span class="m">7</span><span class="p">,</span> <span class="m">8</span><span class="p">,</span> <span class="m">9</span> <span class="p">});</span>
        <span class="n">MemoryBuffer1D</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="n">Stride1D</span><span class="p">.</span><span class="n">Dense</span><span class="p">&gt;</span> <span class="n">deviceOutput</span> <span class="p">=</span> <span class="n">accelerator</span><span class="p">.</span><span class="n">Allocate1D</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;(</span><span class="m">10</span><span class="n">_000</span><span class="p">);</span>

        <span class="c1">// load / precompile the kernel</span>
        <span class="n">Action</span><span class="p">&lt;</span><span class="n">Index1D</span><span class="p">,</span> <span class="n">ArrayView</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;,</span> <span class="n">ArrayView</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;&gt;</span> <span class="n">loadedKernel</span> <span class="p">=</span> 
            <span class="n">accelerator</span><span class="p">.</span><span class="n">LoadAutoGroupedStreamKernel</span><span class="p">&lt;</span><span class="n">Index1D</span><span class="p">,</span> <span class="n">ArrayView</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;,</span> <span class="n">ArrayView</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;&gt;(</span><span class="n">Kernel</span><span class="p">);</span>

        <span class="c1">// finish compiling and tell the accelerator to start computing the kernel</span>
        <span class="nf">loadedKernel</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">deviceOutput</span><span class="p">.</span><span class="n">Length</span><span class="p">,</span> <span class="n">deviceData</span><span class="p">.</span><span class="n">View</span><span class="p">,</span> <span class="n">deviceOutput</span><span class="p">.</span><span class="n">View</span><span class="p">);</span>

        <span class="c1">// wait for the accelerator to be finished with whatever it's doing</span>
        <span class="c1">// in this case it just waits for the kernel to finish.</span>
        <span class="n">accelerator</span><span class="p">.</span><span class="nf">Synchronize</span><span class="p">();</span>

        <span class="c1">// moved output data from the GPU to the CPU for output to console</span>
        <span class="kt">int</span><span class="p">[]</span> <span class="n">hostOutput</span> <span class="p">=</span> <span class="n">deviceOutput</span><span class="p">.</span><span class="nf">GetAsArray1D</span><span class="p">();</span>

        <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="m">50</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
        <span class="p">{</span>
            <span class="n">Console</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="n">hostOutput</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
            <span class="n">Console</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="s">" "</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="n">accelerator</span><span class="p">.</span><span class="nf">Dispose</span><span class="p">();</span>
        <span class="n">context</span><span class="p">.</span><span class="nf">Dispose</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="the-following-parts-already-have-detailed-explainations-in-other-tutorials">The following parts already have detailed explainations in other tutorials:</h2>

<h4 id="context-and-an-accelerator"><a href="/docs/02-beginner/01-context-and-accelerators/">Context and an accelerator.</a></h4>

<div class="language-c# highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Context</span> <span class="n">context</span> <span class="p">=</span> <span class="n">Context</span><span class="p">.</span><span class="nf">CreateDefault</span><span class="p">();</span>
<span class="n">Accelerator</span> <span class="n">accelerator</span> <span class="p">=</span> <span class="n">context</span><span class="p">.</span><span class="nf">GetPreferredDevice</span><span class="p">(</span><span class="n">preferCPU</span><span class="p">:</span> <span class="k">false</span><span class="p">)</span>
                            <span class="p">.</span><span class="nf">CreateAccelerator</span><span class="p">(</span><span class="n">context</span><span class="p">);</span>
</code></pre></div></div>

<p>Creates an Accelerator using GetPreferredDevice to hopefully get the “best” device.</p>

<h4 id="some-kind-of-data-and-output-device-memory"><a href="/docs/02-beginner/02-memorybuffers-and-arrayviews/">Some kind of data and output device memory</a></h4>

<div class="language-c# highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">MemoryBuffer1D</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="n">Stride1D</span><span class="p">.</span><span class="n">Dense</span><span class="p">&gt;</span> <span class="n">deviceData</span> <span class="p">=</span> <span class="n">accelerator</span><span class="p">.</span><span class="nf">Allocate1D</span><span class="p">(</span><span class="k">new</span> <span class="kt">int</span><span class="p">[]</span> <span class="p">{</span> <span class="m">0</span><span class="p">,</span> <span class="m">1</span><span class="p">,</span> <span class="m">2</span><span class="p">,</span> <span class="m">3</span><span class="p">,</span> <span class="m">4</span><span class="p">,</span> <span class="m">5</span><span class="p">,</span> <span class="m">6</span><span class="p">,</span> <span class="m">7</span><span class="p">,</span> <span class="m">8</span><span class="p">,</span> <span class="m">9</span> <span class="p">});</span>
<span class="n">MemoryBuffer1D</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="n">Stride1D</span><span class="p">.</span><span class="n">Dense</span><span class="p">&gt;</span> <span class="n">deviceOutput</span> <span class="p">=</span> <span class="n">accelerator</span><span class="p">.</span><span class="n">Allocate1D</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;(</span><span class="m">10</span><span class="n">_000</span><span class="p">);</span>
</code></pre></div></div>

<p>Loads some example data into the device memory, using dense striding.</p>

<div class="language-c# highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span><span class="p">[]</span> <span class="n">hostOutput</span> <span class="p">=</span> <span class="n">deviceOutput</span><span class="p">.</span><span class="nf">GetAsArray1D</span><span class="p">();</span>
</code></pre></div></div>

<p>After we run the kernel we need to get the data as host memory to use it in CPU code.</p>

<h2 id="this-leaves-just-few-parts-that-need-further-explaination">This leaves just few parts that need further explaination.</h2>

<p>Ok now we get to the juicy bits.</p>

<h4 id="the-kernel-function-definition">The kernel function definition.</h4>

<div class="language-c# highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">static</span> <span class="k">void</span> <span class="nf">Kernel</span><span class="p">(</span><span class="n">Index1D</span> <span class="n">i</span><span class="p">,</span> <span class="n">ArrayView</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;</span> <span class="n">data</span><span class="p">,</span> <span class="n">ArrayView</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;</span> <span class="n">output</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">output</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">=</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span> <span class="p">%</span> <span class="n">data</span><span class="p">.</span><span class="n">Length</span><span class="p">];</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Kernels have a few limitations, but basically anything simple works like you would expect.
Primitives and math operations all work with no issues and as shown above ArrayViews
take the place of arrays.</p>

<p>The main limitation comes down to memory. You can only allocate and pass non-nullable value
types that have a set size. Structs that have arrays can cause issues but more on this in
the future struct tutorial. In general I have had little issue working around this. Most
of the change is in how data is stored. As for my classes it was not to hard to change
over to using structs. Anyways, I am digressing there could be a whole series of tutorials
to cover this in detail.</p>

<p>In general:</p>

<ul>
  <li>no classes (This may change in an upcoming version of ILGPU)</li>
  <li>no references</li>
  <li>no structs with dynamic sizes</li>
</ul>

<p>The first parameter in a kernel must be its index. A kernel always iterates over some extent, which
is some 1, 2 or 3 dimensional length. Most of the time this is the length of the output MemoryBuffer<sup>0</sup>.
When you call the kernel this is what you will use, but inside the kernel function the index is the
threadIndex for the kernel.</p>

<p>The other parameters can be structs or ArrayViews. You can have I <em>think</em> 19 parmeters in total. If you
are approching this limit consider packing things into structs. Honestly before 19 parmeters you should pack things
into structs just to keep it organized.</p>

<p>The function is whatever your algorithm needs. Be very careful of race conditions, and remember that the kernel is the *
inside* of a for loop,
not the for loop itself.</p>

<p>Your code structure will greatly affect performance. This is another complex topic but in general
try to avoid branches<sup>1</sup> and code that would change in different kernel indices. The thing you are trying
to avoid is threads that are running different instructions, this is called divergence.</p>

<h4 id="the-loaded-instance-of-a-kernel">The loaded instance of a kernel.</h4>

<div class="language-c# highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Action</span><span class="p">&lt;</span><span class="n">Index1D</span><span class="p">,</span> <span class="n">ArrayView</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;,</span> <span class="n">ArrayView</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;&gt;</span> <span class="n">loadedKernel</span> <span class="p">=</span> 
    <span class="n">accelerator</span><span class="p">.</span><span class="n">LoadAutoGroupedStreamKernel</span><span class="p">&lt;</span><span class="n">Index1D</span><span class="p">,</span> <span class="n">ArrayView</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;,</span> <span class="n">ArrayView</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;&gt;(</span><span class="n">Kernel</span><span class="p">);</span>
</code></pre></div></div>

<p>This is where you precompile the code. It returns an action with the same parameters as the kernel.</p>

<p>When you compile your C# project you compile all the code into IL. This is a version of your code
that is optimized to be run by the dotnet runtime. ILGPU takes this IL and compiles it to a version
that your accelerator can run. This step is done at runtime whenever you load a kernel or if you
explicitly compile it.</p>

<p>If you are having issues compiling code try testing with the CPUAccelerator.</p>

<h4 id="the-actual-kernel-call-and-device-synchronize">The actual kernel call and device synchronize.</h4>

<div class="language-c# highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">loadedKernel</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">deviceOutput</span><span class="p">.</span><span class="n">Length</span><span class="p">,</span> <span class="n">deviceData</span><span class="p">.</span><span class="n">View</span><span class="p">,</span> <span class="n">deviceOutput</span><span class="p">.</span><span class="n">View</span><span class="p">);</span>
<span class="n">accelerator</span><span class="p">.</span><span class="nf">Synchronize</span><span class="p">();</span>
</code></pre></div></div>

<p>This is the step that does the actual work!</p>

<p>The first step is for ILGPU to finish compiling the kernel, this only happens the first time
the kernel is called, or any time a SpecializedValue&lt;&gt; parameter is changed.</p>

<p>Remember that the index parameter is actually the extent of the kernel when you call it,
but in the actual kernel function it is the index.</p>

<p>Kernel calls are asynchronous. When you call them they are added to a work queue that is controlled by the stream.
So if you call kernel A then kernel B you are guaranteed that A is done before B is started, provided you call them
from the same stream.</p>

<p>Then when you call accelerator.Synchronize(); or stream.Synchronize(); your current thread will wait until
the accelerator (all the streams), or the stream in the case of stream.Synchronize(); is finished executing your
kernels.</p>

<p>See Also:</p>

<p><a href="https://github.com/m4rs-mt/ILGPU/tree/master/Samples/SimpleKernel">Simple Kernel Sample</a></p>

<p><a href="https://github.com/m4rs-mt/ILGPU/tree/master/Samples/SimpleMath">Simple Math Sample</a></p>

<blockquote>
  <p><sup>0</sup>
While it is easiest to group kernels based on the extent of the output buffer
it is likely <em>faster</em> to group them based on the hardware that is running the kernel.
For example there is this method of eaking out the most performance from the GPU called a
<a href="https://developer.nvidia.com/blog/cuda-pro-tip-write-flexible-kernels-grid-stride-loops/">Grid Stride Loop</a>,
it can help more efficently use the limited memory bandwidth, as well as more efficently use all the warps.</p>
</blockquote>

<blockquote>
  <p><sup>1</sup>
This is general advice that everyone gives for programming now, and I take a bit of issue with it. Branches are NOT
slow.
For the CPU, branches that are unpredictable are slow, and for the GPU, branches that are divergent across the same
warp are slow.
Figuring out if that is the case is hard, which is why the general advice is avoid
branches. <a href="https://youtu.be/HG6c4Kwbv4I?t=2532">Matt Godbolt ran into this issue and describes it well in this talk</a></p>
</blockquote>


                
    <div class="f5 contribution">
        <h2>Help us make these docs great!</h2>
        <p>All ILGPU docs are open source. See something that's wrong or unclear? Submit a
            pull request.</p>
        <a class="btn"
           href="https://github.com/m4rs-mt/ILGPU/edit/master/Docs/02_Beginner/03_Kernels-and-Simple-Programs.md"
           target="_blank" rel="noopener">
            <svg aria-hidden="true" role="img" class="octicon mr-1" viewBox="0 0 16 16" width="16" height="16"
                 fill="currentColor"
                 style="display:inline-block;user-select:none;vertical-align:text-bottom;overflow:visible">
                <path fill-rule="evenodd"
                      d="M7.177 3.073L9.573.677A.25.25 0 0110 .854v4.792a.25.25 0 01-.427.177L7.177 3.427a.25.25 0 010-.354zM3.75 2.5a.75.75 0 100 1.5.75.75 0 000-1.5zm-2.25.75a2.25 2.25 0 113 2.122v5.256a2.251 2.251 0 11-1.5 0V5.372A2.25 2.25 0 011.5 3.25zM11 2.5h-1V4h1a1 1 0 011 1v5.628a2.251 2.251 0 101.5 0V5A2.5 2.5 0 0011 2.5zm1 10.25a.75.75 0 111.5 0 .75.75 0 01-1.5 0zM3.75 12a.75.75 0 100 1.5.75.75 0 000-1.5z"></path>
            </svg>
            Make a contribution</a>
        <p class="color-fg-muted f6 mt-2">Or,<!-- --> <a
                    href="https://github.com/m4rs-mt/ILGPU#general-contribution-guidelines"
                    target="_blank" rel="noopener">learn how to contribute.</a>
        </p>
    </div>


            </div>
        </section><!-- End Inner Page Section -->
    
</main><!-- End #main -->
<!-- ======= Footer ======= -->
<footer id="footer">
    <div class="container footer-bottom clearfix text-center">
        <div>
            &copy; Copyright
            <script type="text/javascript">document.write(String(new Date().getFullYear()));</script>
            <strong><span>ILGPU</span></strong>. All Rights Reserved.
        </div>
        
        
        
    </div>
</footer><!-- End Footer -->

<div id="preloader"></div>
<!-- loading Spinner -->

<a href="#" class="back-to-top d-flex align-items-center justify-content-center">
    <i class="bi bi-arrow-up-short"></i>
</a>
<!-- Go to Top button -->

<!-- ARSHA Vendor JS Files -->
<script defer src="/assets/vendor/aos/aos.js"></script>
<script defer src="/assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
<script defer src="/assets/vendor/glightbox/js/glightbox.min.js"></script>
<script defer src="/assets/vendor/isotope-layout/isotope.pkgd.min.js"></script>
<script defer src="/assets/vendor/swiper/swiper-bundle.min.js"></script>
<script defer src="/assets/vendor/waypoints/noframework.waypoints.js"></script>
<script defer src="/assets/vendor/php-email-form/validate.js"></script>
<!-- ARSHA Vendor JS Files -->

<!-- ARSHA Template Main JS File -->
<script defer src="/assets/js/main.js"></script>
<!-- ARSHA Template Main JS File -->

    <!-- Dark Theme -->

<!-- Dark Theme -->

<!-- Search Feature -->

    <script defer src="/assets/vendor/jquery/jquery-3.6.0.min.js"></script>
    <script defer src="/assets/vendor/typeahead/typeahead.bundle.js"></script>
    <script defer src="/assets/vendor/lunr/lunr.js"></script>
    <script defer src="/assets/js/search.js"></script>
    <script defer src="/assets/js/sidebar-collapse.js"></script>

<!-- Search Feature -->

<!-- Code Highlighting -->
<script defer src="/assets/vendor/highlight/highlight.min.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        hljs.highlightAll();
    })
</script>
<script defer src="/assets/vendor/prism/prism.js"></script>
<!-- Code Highlighting -->





</body>

</html>
